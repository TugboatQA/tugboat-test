<html>
  <head>
    <title>Tugboat Test Page</title>
    <link href="style.css" rel="stylesheet" type="text/css" />
  </head>
  <body>
    <div id="page-wrapper">
      <h1>Tubgoat Chat Bot</h1>

      <div id="status">
        <span class="dot"></span>
        <p>Conecting to the appâ€¦</p>
      </div>

      <ul id="messages"></ul>

      <form id="form-msg" action="#" method="post">
        <textarea
          id="msg"
          placeholder="Write your msg here!"
          required
        ></textarea>

        <div id="buttons">
          <button type="submit">Send msg</button>
          <button type="button" id="close">Close connection</button>
        </div>
      </form>
    </div>
  </body>
  <script>
    window.onload = function () {
      // get the references of the page elements.
      const form = document.getElementById("form-msg");
      const txtMsg = document.getElementById("msg");
      const socketStatus = document.getElementById("status");
      const listMsgs = document.getElementById("messages");

      const btnClose = document.getElementById("close");
      connect();

      function connect() {
        const host = `${location.host}${location.pathname}`;
        const socketProtocol = location.protocol === "https:" ? "wss" : "ws";
        let socket = new WebSocket(`${socketProtocol}://${host}/socket`);
        socket.onopen = function (event) {
          socketStatus.innerHTML = "Connected to Socket";
          socketStatus.className = "open";
          btnClose.firstChild.data = "Close connection";
        };

        socket.onerror = function (error) {
          console.log("WebSocket error: " + error);
          console.dir(error);
        };

        btnClose.onclick = function (ev) {
          const readyState = socket?.readyState;
          if (readyState !== 1) {
            return connect();
          }
          socket?.close();
        };

        form.onsubmit = function (e) {
          e.preventDefault();

          // Recovering the message of the textarea.
          const msg = txtMsg.value;

          // Sending the msg via WebSocket.
          socket.send(msg);

          // Adding the msg in a list of sent messages.

          listMsgs.innerHTML +=
            '<li class="sent"><span>Sent:</span>' + msg + "</li>";

          // Cleaning up the field after sending.
          txtMsg.value = "";

          return false;
        };

        socket.onmessage = function (event) {
          const msg = event.data;
          console.log(msg);

          listMsgs.innerHTML +=
            '<li class="received"><span>Received:</span>' + msg + "</li>";
        };

        socket.onclose = function (event) {
          socketStatus.innerHTML = "Disconnected from the WebSocket.";
          socketStatus.className = "closed";
          btnClose.firstChild.data = "Connect";
        };
      }
    };
  </script>
</html>
